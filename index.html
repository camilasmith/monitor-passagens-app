<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Global de Passagens</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'brand': { '500': '#3b82f6', '600': '#2563eb' },
                        'gray': { '850': '#182134', '950': '#0b111e' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #cbd5e1; }
        .card-item { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        .nav-btn.active { color: #3b82f6; background-color: #3b82f61a; }
    </style>
</head>
<body class="dark">

    <div class="flex h-screen bg-gray-950 text-slate-300">
        <!-- Menu Lateral -->
        <aside class="w-20 bg-gray-950 p-4 flex flex-col items-center border-r border-slate-800">
            <div class="text-brand-500 font-bold text-xl">S&R</div>
            <nav class="flex flex-col items-center gap-6 mt-12">
                <button id="nav-search" class="nav-btn p-3 rounded-xl hover:bg-slate-800 transition-colors" title="Buscar Voos">
                    <i data-lucide="search" class="w-6 h-6"></i>
                </button>
                <button id="nav-alerts" class="nav-btn p-3 rounded-xl hover:bg-slate-800 transition-colors" title="Meus Alertas">
                    <i data-lucide="bell" class="w-6 h-6"></i>
                </button>
                <button id="nav-settings" class="nav-btn p-3 rounded-xl hover:bg-slate-800 transition-colors" title="Configurações">
                    <i data-lucide="settings" class="w-6 h-6"></i>
                </button>
            </nav>
        </aside>

        <!-- Painel de Filtros -->
        <section class="w-full max-w-sm bg-slate-900 p-6 flex flex-col border-r border-slate-800">
            <h2 class="text-2xl font-bold text-white mb-6">Encontrar Oportunidades</h2>
            <form id="search-form" class="space-y-4 overflow-y-auto pr-2 flex-grow">
                <div>
                    <label class="text-sm font-medium">Origem / Destino</label>
                    <div class="flex flex-col gap-2 mt-1">
                        <input type="text" id="origin" placeholder="Origem (Obrigatório)" required class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 focus:ring-brand-500 focus:border-brand-500">
                        <input type="text" id="destination" placeholder="Destino (Opcional)" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 focus:ring-brand-500 focus:border-brand-500">
                    </div>
                     <p class="text-xs text-slate-500 mt-2">Deixe o destino em branco para explorar as melhores ofertas.</p>
                </div>
                <div>
                    <label class="text-sm font-medium">Datas</label>
                    <div class="flex gap-2 mt-1">
                        <input type="date" id="departureDate" required title="Data de Ida" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 focus:ring-brand-500 focus:border-brand-500">
                        <input type="date" id="returnDate" title="Data de Volta (Opcional)" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 focus:ring-brand-500 focus:border-brand-500">
                    </div>
                </div>
            </form>
             <div class="mt-4 pt-4 border-t border-slate-800">
                <button type="submit" form="search-form" class="w-full bg-brand-600 text-white font-bold py-3 rounded-lg hover:bg-brand-500 transition-all shadow-lg flex items-center justify-center">
                    <i data-lucide="search" class="w-5 h-5 mr-2"></i>Buscar Agora
                </button>
            </div>
        </section>

        <!-- Conteúdo Principal -->
        <main class="flex-1 p-6 lg:p-8 overflow-y-auto flex flex-col">
            <header class="flex justify-between items-center mb-6">
                 <div>
                    <h2 id="main-title" class="text-3xl font-bold text-white">Resultados da Busca</h2>
                    <span id="results-count" class="text-sm font-medium text-slate-400"></span>
                 </div>
                 <div class="flex items-center gap-2 text-sm text-slate-400">
                    <div id="status-indicator"></div>
                    <span id="status-text">Pronto para buscar.</span>
                </div>
            </header>

            <div id="panel-search-results" class="grid grid-cols-1 xl:grid-cols-2 2xl:grid-cols-3 gap-6"></div>
            <p id="feed-placeholder" class="text-center text-slate-500 col-span-full pt-16">Use o painel à esquerda para buscar uma rota.</p>
            <div id="panel-my-alerts" class="hidden space-y-4"></div>
            <div id="panel-settings" class="hidden">
                 <form id="settings-form" class="max-w-2xl mx-auto">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="mile-value-inputs"></div>
                    <div class="mt-6">
                        <button type="submit" class="w-full bg-brand-600 text-white font-bold py-3 rounded-lg hover:bg-brand-500 transition-all shadow-lg">Salvar Custos</button>
                    </div>
                </form>
            </div>
        </main>
    </div>
    
    <script>
        lucide.createIcons();

        const API_BASE_URL = 'https://monitor-passagens-server.onrender.com';
        
        const elements = {};
        ['nav-search', 'nav-alerts', 'nav-settings', 'search-form', 'main-title', 'panel-search-results', 'panel-my-alerts', 'panel-settings', 'status-text', 'status-indicator', 'feed-placeholder', 'results-count', 'settings-form', 'mile-value-inputs'].forEach(id => {
            if (document.getElementById(id)) elements[id] = document.getElementById(id);
        });
        
        let myAlerts = [];
        
        const defaultAirlinesData = { 'G3': { name: 'GOL', program: 'Smiles', mileValue: 18 },'LA': { name: 'LATAM', program: 'LATAM Pass', mileValue: 28 },'AD': { name: 'Azul', program: 'TudoAzul', mileValue: 22 },'TP': { name: 'TAP', program: 'Miles&Go', mileValue: 75 },'UA': { name: 'United', program: 'MileagePlus', mileValue: 120 },'AA': { name: 'American', program: 'AAdvantage', mileValue: 100 },'QR': { name: 'Qatar', program: 'Privilege Club', mileValue: 57 },'IB': { name: 'Iberia', program: 'Iberia Plus', mileValue: 90 },'BA': { name: 'British', program: 'Executive Club', mileValue: 90 }, 'AC': { name: 'Air Canada', program: 'Aeroplan', mileValue: 110 } };
        let airlinesData = { ...defaultAirlinesData };

        function updateStatus(message, color = 'gray') {
            if (elements['status-text']) elements['status-text'].textContent = message;
            if (elements['status-indicator']) {
                const colors = { gray: 'bg-slate-500', blue: 'bg-blue-500', green: 'bg-green-500', red: 'bg-red-500' };
                elements['status-indicator'].innerHTML = `<div class="relative flex h-3 w-3"><span class="animate-ping absolute inline-flex h-full w-full rounded-full ${colors[color]} opacity-75"></span><span class="relative inline-flex rounded-full h-3 w-3 ${colors[color]}"></span></div>`;
            }
        }

        async function handleSearch(origin, destination, departureDate, returnDate) {
            elements['feed-placeholder'].style.display = 'none';
            elements['panel-search-results'].innerHTML = '';
            elements['results-count'].textContent = '';
            const searchType = destination ? `Buscando ${origin}→${destination}...` : `Explorando ofertas de ${origin}...`;
            updateStatus(searchType, 'blue');

            try {
                const params = new URLSearchParams({ origin });
                const isExploreMode = !destination;
                
                if (destination) params.append('destination', destination);
                if (departureDate) params.append('departureDate', departureDate);
                if (returnDate && destination) params.append('returnDate', returnDate);
                
                const endpoint = isExploreMode ? '/api/explore-deals' : '/api/search-flights';
                const response = await fetch(`${API_BASE_URL}${endpoint}?${params.toString()}`);
                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                
                const responseData = await response.json();
                const offers = responseData.data || (Array.isArray(responseData) ? responseData : []);

                if (offers.length === 0) {
                    updateStatus(`Nenhuma oferta encontrada.`, 'gray');
                    elements['panel-search-results'].innerHTML = `<p class="text-center text-slate-500 col-span-full pt-16">Nenhuma oferta encontrada.</p>`;
                    return;
                }
                
                const cardRenderer = isExploreMode ? renderExploreCard : renderFlightCard;
                elements['panel-search-results'].innerHTML = offers.map(cardRenderer).join('');
                elements['results-count'].textContent = `${offers.length} ofertas encontradas`;
                lucide.createIcons();
                updateStatus('Busca concluída!', 'green');

            } catch (error) {
                console.error("Falha ao buscar promoções:", error);
                updateStatus('Erro ao buscar. Verifique o console.', 'red');
            }
        }
        
        function renderFlightCard(flightData) {
            try {
                const { price, itineraries, validatingAirlineCodes } = flightData;
                const airlineCode = validatingAirlineCodes[0];
                const airlineInfo = airlinesData[airlineCode] || { name: airlineCode, program: 'N/A', mileValue: 50 };
                const firstItinerary = itineraries[0];
                const secondItinerary = itineraries.length > 1 ? itineraries[1] : null;
                const originCode = firstItinerary.segments[0].departure.iataCode;
                const destinationCode = firstItinerary.segments[firstItinerary.segments.length - 1].arrival.iataCode;
                const departureDate = new Date(firstItinerary.segments[0].departure.at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                const returnDate = secondItinerary ? new Date(secondItinerary.segments[0].departure.at).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' }) : null;
                const dateText = returnDate ? `${departureDate} - ${returnDate}` : departureDate;
                const tripType = returnDate ? 'Ida e Volta' : 'Só Ida';
                const cashPrice = parseFloat(price.total);
                const estimatedMiles = Math.round(cashPrice / (airlineInfo.mileValue / 1000));
                const valuePerMile = (cashPrice / estimatedMiles * 1000);
                const recommendationHTML = valuePerMile < airlineInfo.mileValue ? `<div class="text-sm font-semibold text-green-400">Vale a pena em Milhas</div>` : `<div class="text-sm font-semibold text-amber-400">Pague em Dinheiro</div>`;
                const promoUrl = `https://www.google.com/flights#flt=${originCode}.${destinationCode}.${new Date(firstItinerary.segments[0].departure.at).toISOString().split('T')[0]}${returnDate ? `*${destinationCode}.${originCode}.${new Date(secondItinerary.segments[0].departure.at).toISOString().split('T')[0]}` : ''}`;
                return `<div class="card-item bg-slate-900 border border-slate-800 rounded-2xl shadow-lg flex flex-col"><div class="p-5 flex flex-col flex-grow"><div class="flex justify-between items-center"><div class="flex items-center gap-2"><img src="https://logo.clearbit.com/${airlineInfo.name.toLowerCase().replace(/\s/g, '')}.com" onerror="this.style.display='none'" class="h-6 w-6 rounded-full bg-slate-700"/><span class="text-sm font-semibold text-slate-300">${airlineInfo.name}</span></div><span class="text-xs font-semibold uppercase px-2 py-1 rounded-full bg-slate-800 text-slate-400">${tripType}</span></div><div class="my-4 text-center"><div class="flex items-center justify-center gap-2 text-xl font-bold text-white"><span>${originCode}</span><i data-lucide="arrow-right" class="w-5 h-5 text-slate-500"></i><span>${destinationCode}</span></div><div class="text-sm text-slate-400 mt-1">${dateText}</div></div><div class="grid grid-cols-2 gap-4 text-center"><div class="bg-slate-800/50 rounded-lg p-3"><div class="text-lg text-white font-bold">R$ ${cashPrice.toFixed(2)}</div><div class="text-xs text-slate-400">Em dinheiro</div></div><div class="bg-slate-800/50 rounded-lg p-3"><div class="text-lg text-white font-bold">${estimatedMiles.toLocaleString('pt-BR')}</div><div class="text-xs text-slate-400">${airlineInfo.program}</div></div></div><div class="text-center mt-3">${recommendationHTML}<div class="text-xs text-slate-500">~R$ ${valuePerMile.toFixed(2)} / milheiro</div></div></div><div class="mt-auto bg-slate-800/50 p-4 rounded-b-2xl"><a href="${promoUrl}" target="_blank" class="w-full bg-brand-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-brand-500 transition-colors flex items-center justify-center text-sm">Ver Oferta</a></div></div>`;
            } catch (e) { console.error(e); return ''; }
        }

        function renderExploreCard(dealData) { /* ...código existente... */ }
        function renderSettingsPanel() {
            elements['mile-value-inputs'].innerHTML = Object.entries(airlinesData).map(([code, data]) => `
                <div class="flex flex-col">
                    <label for="mile-value-${code}" class="text-sm font-medium text-slate-300 mb-1">${data.program} (${code})</label>
                    <input type="number" step="0.1" id="mile-value-${code}" data-code="${code}" value="${data.mileValue}" class="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 focus:ring-brand-500 focus:border-brand-500">
                </div>
            `).join('');
        }
        function saveAirlinesDataToLocalStorage() { localStorage.setItem('customAirlinesData', JSON.stringify(airlinesData)); }
        function loadAirlinesDataFromLocalStorage() { const saved = localStorage.getItem('customAirlinesData'); if (saved) airlinesData = {...defaultAirlinesData, ...JSON.parse(saved)}; }
        
        elements['search-form'].addEventListener('submit', (e) => { e.preventDefault(); const origin = document.getElementById('origin').value.toUpperCase().trim(); const dest = document.getElementById('destination').value.toUpperCase().trim(); const depDate = document.getElementById('departureDate').value; const retDate = document.getElementById('returnDate').value; if (origin) handleSearch(origin, dest, depDate, retDate); });
        
        const navButtons = [elements['nav-search'], elements['nav-alerts'], elements['nav-settings']];
        const panels = [elements['panel-search-results'], elements['panel-my-alerts'], elements['panel-settings']];
        
        navButtons.forEach((button, index) => {
            if (!button) return;
            button.addEventListener('click', () => {
                navButtons.forEach(btn => btn && btn.classList.remove('active'));
                button.classList.add('active');
                
                panels.forEach(panel => panel && panel.classList.add('hidden'));
                if (panels[index]) panels[index].classList.remove('hidden');

                elements['feed-placeholder'].style.display = (button.id !== 'nav-search' || elements['panel-search-results'].innerHTML !== '') ? 'none' : 'block';
                
                const titles = {'nav-search': 'Resultados da Busca', 'nav-alerts': 'Meus Alertas', 'nav-settings': 'Configurar Custo do Milheiro'};
                elements['main-title'].textContent = titles[button.id] || 'Resultados';
                elements['results-count'].style.display = (button.id === 'nav-search') ? 'inline' : 'none';

                if (button.id === 'nav-settings') renderSettingsPanel();
            });
        });
        
        if(elements['settings-form']) {
            elements['settings-form'].addEventListener('submit', (e) => {
                e.preventDefault();
                const inputs = elements['mile-value-inputs'].querySelectorAll('input');
                inputs.forEach(input => {
                    const code = input.dataset.code;
                    const value = parseFloat(input.value);
                    if (airlinesData[code] && !isNaN(value)) airlinesData[code].mileValue = value;
                });
                saveAirlinesDataToLocalStorage();
                alert('Custos do milheiro salvos com sucesso!');
            });
        }
        document.addEventListener('DOMContentLoaded', () => {
            loadAirlinesDataFromLocalStorage();
            if (elements['nav-search']) elements['nav-search'].click();
        });
    </script>
</body>
</html>

